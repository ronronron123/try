
<?php include('../includes/layouts/main-layouts/head-section.php') ?>

<?php
	include('upload-image.php');

	$info_id = $customize['id'];
	if(!canAccessInventory()) {
		echo "<script>alert('Access Denied!');window.open('index', '_self');</script>";
	}
	
	$inventories = $model->getAllInventory();
	$estLifes = $model->displayEstLife();
	$categories = $model->displayCategories();	
	$units = $model->displayUnits();
	$notes = $model->displayModuleNotes('inventory');
?>

<title>Inventory | <?php echo $customize['sys_name']; ?></title>

</head>
<body class="ttr-opened-sidebar ttr-pinned-sidebar" style="background-color: #F3F3F3;">

<!-- main header -->
<?php include('../includes/layouts/main-layouts/ttr-header.php') ?>

	<nav class="ttr-sidebar-navi">
		<ul>
			<li style="padding-left: 20px; padding-top: 5px; padding-bottom: 5px; margin-top: 0px; margin-bottom: 0px;">
				<span class="ttr-label" style="color: #D5D6D8; font-weight: 500;">Main Navigation</span>
			</li>
			<li class="" style="margin-top: 0px;">
				<a href="index" class="ttr-material-button">
					<span class="ttr-icon"><i class="fa fa-home" aria-hidden="true"></i></span>
					<span class="ttr-label">Dashboard</span>
				</a>
			</li>
			<li class="" style="margin-top: 0px;">
				<a href="create-order.php" class="ttr-material-button">
					<span class="ttr-icon"><i class="fa fa-home" aria-hidden="true"></i></span>
					<span class="ttr-label">Create Order</span>
				</a>
			</li>
			<li class="" style="margin-top: 0px;">
				<a href="order-history.php" class="ttr-material-button">
					<span class="ttr-icon"><i class="fa fa-home" aria-hidden="true"></i></span>
					<span class="ttr-label">Order History</span>
				</a>
			</li>
			<?php if(canAccessInventory()): ?>
			<li class="show" style="margin-top: 0px;">
				<a href="inventory" class="ttr-material-button">
					<span class="ttr-icon"><i class="fa fa-database" aria-hidden="true"></i></span>
					<span class="ttr-label">Inventory</span>
				</a>
			</li>
			<?php endif ?>

			<?php if(canAccessUser() || canAccessRole()): ?>
			<li class="" style="margin-top: 0px;">
				<div class="accordion accordion-flush" id="accordionUser">
					<div class="accordion-item">
						<h2 class="accordion-header">
						<button class="accordion-button ps-3.5 py-1 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo" ><i class="fa fa-user me-2 pe-3" aria-hidden="true"></i>
						User Management
						</button>
						</h2>
					<div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionUser">
					<div class="accordion-body p-0">
						<?php if(canAccessUser()): ?>
						<div>
							<a href="users" class="ttr-material-button mx-0 my-0">
								<span class="ttr-icon"></span>
								<span class="ttr-label">User</span>
							</a>
						</div>
						<?php endif; ?>
						<?php if(canAccessRole()): ?>
						<div>
							<a href="roles" class="ttr-material-button mx-0 my-0">
								<span class="ttr-icon"></span>
								<span class="ttr-label">Roles</span>
							</a>
						</div>
						<?php endif; ?>
					</div>
				</div>
			</li>
			<?php endif; ?>

			<?php if(canAccessCategory()): ?>
			<li class="" style="margin-top: 0px;">
				<a href="category" class="ttr-material-button">
					<span class="ttr-icon"><i class="fa fa-cubes" aria-hidden="true"></i></span>
					<span class="ttr-label">Categories</span>
				</a>
			</li>
			<?php endif; ?>
			
			<?php if(canAccessReport()): ?>
			<li class="" style="margin-top: 0px;">
				<a href="report.php" class="ttr-material-button">
					<span class="ttr-icon"><i class="fa fa-bar-chart" aria-hidden="true"></i></span>
					<span class="ttr-label">Report</span>
				</a>
			</li>
			<?php endif; ?>
			
			<?php if(canAccessGeneralContent() || canAccessComponents() || canAccessActivityLog() || canAccessArchives()): ?>
				<li style="padding-left: 20px; padding-top: 40px; padding-bottom: 5px; margin-top: 0px; margin-bottom: 0px;">
					<span class="ttr-label" style="color: #D5D6D8; font-weight: 500;">Admin Settings</span>
				</li>
				<?php if(canAccessGeneralContent() || canAccessComponents()): ?>
				<li class="" style="margin-top: 0px;">
					<div class="accordion accordion-flush" id="accordionSettings">
						<div class="accordion-item">
							<h2 class="accordion-header">
							<button class="accordion-button ps-3.5 py-1 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings" aria-expanded="true" aria-controls="collapseSettings" ><i class="fa fa-solid fa-gear me-2 pe-3" aria-hidden="true"></i>
							Settings
							</button>
							</h2>
						<div id="collapseSettings" class="accordion-collapse collapse" data-bs-parent="#accordionSettings">
						<div class="accordion-body p-0">
							<?php if(canAccessGeneralContent()): ?>
							<div class="">
								<a href="system-content" class="ttr-material-button mx-0 my-0">
									<span class="ttr-icon"></span>
									<span class="ttr-label">General Content</span>
								</a>
							</div>
							<?php endif; ?>
							<?php if(canAccessComponents()): ?>
							<div class="">
								<a href="customize" class="ttr-material-button mx-0 my-0">
									<span class="ttr-icon"></span>
									<span class="ttr-label">Components</span>
								</a>
							</div>
							<?php endif; ?>
						</div>
					</div>
				</li>
				<?php endif; ?>
				<?php if(canAccessActivityLog()): ?>
				<li class="" style="margin-top: 0px;">
					<a href="history" class="ttr-material-button">
						<span class="ttr-icon"><i class="fa fa-history" aria-hidden="true"></i></span>
						<span class="ttr-label">Activity Logs</span>
					</a>
				</li>
				<?php endif; ?>
				<?php if(canAccessArchives()): ?>
				<li class="" style="margin-top: 0px;">
					<a href="archive-inventory" class="ttr-material-button">
						<span class="ttr-icon"><i class="ti-archive" aria-hidden="true"></i></span>
						<span class="ttr-label">Archives</span>
					</a>
				</li>
				<?php endif; ?>
			<?php endif; ?>
		</ul>
	</nav>
</div>
</div>
<main class="ttr-wrapper">
	<div class="container-fluid">
		<div class="ttr-container-header row col-lg-12 mb-3">
			<div class="d-flex justify-content-between mx-0 px-0">
				<div class="float-left">
					<h2 class="p-0 ms-2 mb-0">Inventory</h2>
				</div>

				<!-- Create Inventory button -->
				<div>
					
					<?php if(canCreateInventory()): ?>
					<button type="button" class="btn green radius-xl" style="background-color: #5ADA86;" data-toggle="modal" data-target="#insert-inventory">
						<i class="fa fa-plus"></i><span>&nbsp;&nbsp;ADD INVENTORY</span>
					</button>
					<?php endif; ?> 
				</div>
				<!-- Create Inventory button -->

			</div>
		</div>
		<div class="row">
			<div class="col-lg-12">
				<div class="widget-box">
					<div class="widget-inner">
						<div style="padding: 10px;"></div>	

						<!-- Insert inventory record modal -->
						<div id="insert-inventory" class="modal fade" role="dialog">
							<form class="edit-inventory mb-30" method="POST" enctype="multipart/form-data">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h4 class="modal-title">Add Inventory Record</h4>
											<button type="button" class="close" data-dismiss="modal">&times;</button>
										</div>
										<div class="modal-body">
											<div class="row">
												<div class="form-group col-6" style="padding-bottom: 15px;">
													<div class="row">
														<div class="form-group col-12">
															<label class="col-form-label">Property No.</label>
															<input class="form-control" type="text" name="property_no" value="" placeholder="Assign a property number.."  maxlength="18" required>
														</div>
														<div class="form-group col-12">
															<label class="col-form-label">Description</label>
															<textarea class="form-control" name="description" placeholder="Enter property description.." required></textarea>
														</div>
														<!-- Product background image -->
														<form method="POST" enctype="multipart/form-data">
														<div class="form-group col-12">
															<div class="row">
																<div class="col-lg-6 col-xl-6" style="position: relative;">
																	<label class="col-form-label">Product Image</label>
																	<div class="info-body col-12 my-3 px-0" style="height: 60px;">
																		<!-- Image preview will be shown here after selection -->
																		<img id="imagePreview" class="img-fluid" style="height: 50px; width: 40px; display: none;" alt="Preview">
																	</div>
																	<div class="info-footer col-12 px-0 my-2" style="float: left; position: relative;">
																		<!-- Upload button -->
																		<input type="file" class="form-control" name="product-image-background" id="product-image-background" accept="image/*" onchange="previewImage()" required>
																	</div>
																</div>
															</div>
														</div>
														</form>

														<!-- Add a JavaScript function to preview the selected image -->
														<script>
															function previewImage() {
																const fileInput = document.getElementById('product-image-background');
																const imagePreview = document.getElementById('imagePreview');
																const file = fileInput.files[0];
																if (file) {
																	const reader = new FileReader();
																	reader.onload = function (e) {
																		imagePreview.src = e.target.result;
																		imagePreview.style.display = 'block'; // Show the image preview
																	};
																	reader.readAsDataURL(file);
																} else {
																	imagePreview.style.display = 'none'; // Hide the image preview if no file is selected
																}
															}
														</script>

														<div class="form-group col-12">
															<label class="col-form-label">Acquisition Date</label>
															<input class="form-control" type="date" name="acquired_date" value="" required id="acquired_date" max="<?php echo date('Y-m-d'); ?>">
														</div>

														<div class="form-group col-12">
   															<label class="col-form-label">Remarks</label>
   															 <input type="hidden" name="remark" value="4">
   															 <input class="form-control" type="text" value="Serviceable" disabled>
														</div>
												   </div>
												</div>
												<div class="form-group col-6" style="padding-bottom: 15px;">
													<div class="row">
														<div class="form-group col-12">
															<label class="col-form-label">Category</label>
															<select class="form-control" name="category" required>
															<option value="" selected disabled hidden>-- Select category --</option>
															<?php if(!empty($categories)):  ?>
																<?php foreach ($categories as $add_category):  ?>
																		
																<option value="<?php echo $add_category['id']; ?>"><?php echo $add_category['category_name']; ?></option>

																<?php endforeach; ?>
															<?php endif; ?>
															</select>
														</div>
														<div class="form-group col-12">
															<label class="col-form-label">Unit</label>
															<select class="form-control" name="unit" required>
																<option value="" selected disabled hidden>-- Select unit of measurement --</option>
																<?php if(!empty($units)): ?>
																	<?php foreach ($units as $add_unit): ?>

																	<option value="<?php echo $add_unit['id']; ?>"><?php echo $add_unit['unit_name']; ?></option>

																	<?php endforeach; ?>
																<?php endif; ?>
															</select>
														</div>
														<div class="form-group col-12">
															<label class="col-form-label">Quantity:</label>
															<input class="form-control" type="number" name="qty_pcard" id="qty_pcard" value="" min="1" max="9999999" required oninput="validateInteger(this); updateQtyPcount(this)">
															<small id="qty_pcard_warning" class="text-danger" style="display:none;">Please enter an integer.</small>
															</div>
													<script>
													function validateInteger(input) {
														const value = input.value;
														const isInteger = Number.isInteger(Number(value));
														const warningId = input.id + '_warning';
														const warningElement = document.getElementById(warningId);
								
													if (!isInteger) {
														warningElement.style.display = 'block';
														} else {
															warningElement.style.display = 'none';
															}
																}

													function updateQtyPcount(input) {
																const value = input.value;
																	const qtyPcount = document.getElementById('qty_pcount');
																qtyPcount.value = value;
																}
																</script>
														<div class="form-group col-12">
															<label class="col-form-label">Unit Cost (₱) :</label>
															<input class="form-control" type="number"  step="0.01" name="cost" id="cost" value="" min="1" max="999999999" required>
														</div>
														<div class="form-group col-12">
															<label class="col-form-label">Estimated Useful Life</label>
															<select class="form-control" name="est_life" required>
															<option value="" selected disabled hidden>-- Select estimated useful life --</option>
																<?php if(!empty($estLifes)): ?>
																	<?php foreach ($estLifes as $add_estLife): ?>

																		<option value="<?php echo $add_estLife['id']; ?>"><?php echo $add_estLife['est_life']; ?></option>

																	<?php endforeach; ?>
																<?php endif; ?>
															</select>
														</div>
													</div>
												</div>
											</div> <!-- modal-body -->
										</div>
										<div class="modal-footer">
											<input type="submit" class="btn green radius-xl outline" name="insert-inventory" value="Save Changes">
											<button type="button" class="btn red outline radius-xl" data-dismiss="modal">Close</button>
										</div>
									</div> <!-- modal-content -->
								</div> <!-- modal-dialog -->
							</form>
						</div> <!-- Insert inventory record modal -->

						<!-- Inventory table -->
						<div class="table-responsive">
							<table id="table" class="table hover" style="width:100%">
								<thead>
									<tr>
										<th width="140">Image</th>
										<th class="col-3">Description</th>
										<th class="col-1">Quantity</th>
										<th lass="col-1">Category</th>
										<th lass="col-1">Remarks</th>
										<th>Date Added</th>
										<?php if(canReadInventory() && canUpdateInventory() && canDeleteInventory()): ?>
										<th class="col-sm-1 col-lg-2">Action</th>
										<?php elseif(canUpdateInventory() || canDeleteInventory()): ?>
										<th width="100">Action</th>
										<?php elseif(canReadInventory()): ?>
										<th class="col-1">Action</th>
										<?php else: ?>
										<?php endif; ?>
									</tr>	
								</thead>
								<tbody>
									<?php if (!empty($inventories)): ?>
										<?php foreach ($inventories as $inventory): ?>
											<?php $inv_id = $inventory['inv_id']; ?>

										<tr>
										<?php if (!empty($inventory['image_path'])): ?>
											<td>
												<img src="../assets/images/<?php echo htmlspecialchars($inventory['image_path']); ?>" 
													class="img-fluid" 
													alt="Image preview" 
													style="height: 50px; width: 50px;">
											</td>
										<?php endif; ?>
											<td class="description-cell"><?php echo $inventory['description']; ?></td>
											<td><?php echo $inventory['qty_pcard']; ?></td>
											<td><?php echo $inventory['category_name']; ?></td>
											<td>
												<?php if(!empty($invNotes = $model->displayInvNotes('inventory', $inventory['remark_name']))): ?>
													<?php foreach ($invNotes as $invNote): ?>
														<span style="font-size: 12px; color: white; padding: 4px; border-radius: 25px; background-color: <?php echo $invNote['color']; ?>;"><?php echo $invNote['note_name']; ?></span>
													<?php endforeach; ?>
												<?php endif; ?>
											</td>
											<td><?php echo date('M. d, Y g:i A', strtotime($inventory['date_added'])); ?></td>

											<?php if(canReadInventory() || canUpdateInventory() || canDeleteInventory()): ?>
											<td>
												<center>
													<?php if(canReadInventory()): ?>
													<button id="<?php echo $inv_id;?>" onclick="window.location.href='inventory-view.php?id=<?php echo $inventory['inv_id']; ?>'" type="submit" name="view" class="btn green mt-1" style="width: 50px; height: 37px;">
														<span data-toggle="tooltip" title="View">
															<i class="ti-search" style="font-size: 12px;"></i>
														</span>
													</button>
													<?php endif; ?>
													<?php if(canUpdateInventory()): ?>
													<button data-toggle="modal" data-target="#update-<?php echo $inv_id; ?>" class="btn blue mt-1" style="width: 50px; height: 37px;">
														<span data-toggle="tooltip" title="Update">
															<i class="ti-marker-alt" style="font-size: 12px;"></i>
														</span>
													</button>
													<?php endif; ?>
													<?php if(canDeleteInventory()): ?>
													<button data-toggle="modal" data-target="#archive-<?php echo $inv_id; ?>" class="btn red mt-1" style="width: 50px; height: 37px;">
														<span data-toggle="tooltip" title="Archive">
															<i class="ti-archive" style="font-size: 12px;"></i>
														</span>
													</button>
													<?php endif; ?>
												</center>
											</td>
											<?php endif; ?>
										</tr>

										
									
											<!-- Update inventory record modal -->
											<div id="update-<?php echo $inv_id; ?>" class="modal fade" role="dialog">
												<form class="edit-inventory m-b30" method="POST" enctype="multipart/form-data">
													<div class="modal-dialog modal-lg">
														<div class="modal-content">
															<div class="modal-header"><input type="hidden" name="inv_id" value="<?php echo $inv_id; ?>">
																<h4 class="modal-title">Update Inventory Record</h4>
																<button type="button" class="close" data-dismiss="modal">&times;</button>
															</div>
															<div class="modal-body">
																<div class="row">
																	<input type="hidden" name="inv_id" value="<?php echo $inv_id; ?>">
																	<input type="hidden" name="mainInv_no" value="<?php echo $inventory['inv_id']; ?>">
																	<input type="hidden" name="mainProp_no" value="<?php echo $inventory['property_no']; ?>">
																	<div class="form-group col-6" style="padding-bottom: 15px;">
																		<div class="row">
																			<div class="form-group col-12">
																				<label class="col-form-label">Property No.</label>
																				<input class="form-control" type="text" name="property_no" value="<?php echo $inventory['property_no']; ?>" maxlength="18" required>
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Description</label>
																				<textarea class="form-control" name="description" required><?php echo $inventory['description']; ?></textarea>
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Image</label><br>
																				<img src="../assets/images/<?php echo htmlspecialchars($inventory['image_path']); ?>"
																					class="img-fluid" 
																					alt="Image preview" 
																					style="height: 50px; width: 50px;">
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Acquisition Date</label>
																				<input class="form-control" type="date" name="acquired_date" value="<?php echo $formattedDate = date('Y-m-d', strtotime($inventory['acquisition_date'])); ?>" required id="acquired_date" max="<?php echo date('Y-m-d'); ?>">
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Remarks</label>
																				<select class="form-control" name="remark" required>
																				<?php if(!empty($notes)):  ?>
																					<?php foreach ($notes as $update_note):  ?>

																					<option style="font-size: 14px; color: white; padding: 5px; border-radius: 25px; background-color: <?php echo $update_note['color']?>;" value="<?php echo $update_note['id']; ?>" <?php if ($inventory['remark'] == $update_note['id']) { echo 'selected'; } ?>><?php echo $update_note['note_name']; ?></option>

																					<?php endforeach; ?>
																				<?php endif; ?>
																				</select>
																			</div>
																		</div>
																	</div>
																	<div class="form-group col-6" style="padding-bottom: 15px;">
																		<div class="row">
																			<div class="form-group col-12">
																				<label class="col-form-label">Category</label>
																				<select class="form-control" name="category" required>
																				<?php if(!empty($categories)):  ?>
																					<?php foreach ($categories as $update_category):  ?>

																					<option value="<?php echo $update_category['id']; ?>" <?php if ($inventory['category'] == $update_category['id']) { echo 'selected'; } ?>><?php echo $update_category['category_name']; ?></option>

																					<?php endforeach; ?>
																				<?php endif; ?>
																				</select>
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Unit</label>
																				<select class="form-control" name="unit" required>
																					<?php if(!empty($units)): ?>
																						<?php foreach ($units as $update_unit): ?>
																						
																						<option value="<?php echo $update_unit['id']; ?>" <?php if ($inventory['unit'] == $update_unit['id']) { echo 'selected'; } ?>><?php echo $update_unit['unit_name']; ?></option>

																						<?php endforeach; ?>
																					<?php endif; ?>
																				</select>
																			</div>
																			

																			<div class="form-group col-12">
																				<label class="col-form-label">Quantity:</label>
																				<input class="form-control" type="number" name="qty_pcard" id="qty_pcard" value="<?php echo $inventory['qty_pcard']; ?>" max="9999999" maxlength="9" required>
																				<small id="qty_pcard_warning" class="text-danger" style="display:none;">Please enter an integer.</small>
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Unit Cost (₱) :</label>
																				<input class="form-control" type="number"  step="0.01" name="cost" value="<?php echo $inventory['unit_cost']; ?>" min="1" max="9999999999.9" required>
																			</div>
																			<div class="form-group col-12">
																				<label class="col-form-label">Estimated Useful Life</label>
																				<select class="form-control" name="est_life" required>
																					<?php if(!empty($estLifes)): ?>
																						<?php foreach ($estLifes as $update_estLife): ?>

																						<option value="<?php echo $update_estLife['id']; ?>" <?php if ($inventory['est_life'] == $update_estLife['id']) { echo 'selected'; } ?>><?php echo $update_estLife['est_life']; ?></option>

																						<?php endforeach; ?>
																					<?php endif; ?>
																				</select>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
															<div class="modal-footer">
																<input type="submit" class="btn green radius-xl outline" name="update-inventory" value="Save Changes">
																<button type="button" class="btn red outline radius-xl" data-dismiss="modal">Close</button>
															</div>
														</div>
													</div>
												</form>
											</div> <!-- Update inventory record modal -->

											<!-- Archive inventory record modal -->
<div id="archive-<?php echo $inv_id; ?>" class="modal fade" role="dialog">
    <form id="archive-form-<?php echo $inv_id; ?>" class="edit-profile m-b30" method="POST">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Archive Record</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <input type="hidden" name="inv_id" value="<?php echo $inv_id; ?>">
                <div class="modal-body">
                    <div class="row">
                        <input type="hidden" name="inv_id" value="<?php echo $inv_id; ?>">
                        <div class="form-group col-6" style="padding-bottom: 15px;">
                            <div class="row">
                              
                                <div class="form-group col-12">
                                    <label class="col-form-label">Property No.</label>
                                    <input class="form-control" type="text" name="property_no" value="<?php echo $inventory['property_no']; ?>" readonly>
                                </div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Description</label>
                                    <textarea class="form-control" name="description" readonly><?php echo $inventory['description']; ?></textarea>
                                </div>
								<div class="form-group col-12">
									<label class="col-form-label">Image</label><br>
									<img src="../assets/images/<?php echo htmlspecialchars($inventory['image_path']); ?>"
										class="img-fluid" 
										alt="Image preview" 
										style="height: 50px; width: 50px;">
								</div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Acquisition Date</label>
                                    <input class="form-control" type="date" name="acquired_date" value="<?php echo $formattedDate = date('Y-m-d', strtotime($inventory['acquisition_date'])); ?>" readonly>
                                </div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Remarks</label>
                                    <input class="form-control" type="text" name="remark" value="<?php echo $inventory['remark_name']; ?>" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-6" style="padding-bottom: 15px;">
                            <div class="row">
                                <div class="form-group col-12">
                                    <label class="col-form-label">Category</label>
                                    <input class="form-control" type="text" name="category" value="<?php echo $inventory['category_name']; ?>" readonly>
                                </div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Unit</label>
                                    <input class="form-control" type="text" name="unit" value="<?php echo $inventory['unit_name']; ?>" readonly>
                                </div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Quantity:</label>
                                    <input class="form-control" type="number" name="qty_pcard" id="qty_pcard-<?php echo $inv_id; ?>" value="<?php echo $inventory['qty_pcard']; ?>">
                                </div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Unit Cost (₱) :</label>
                                    <input class="form-control" type="number" step="0.01" name="cost" id="cost" value="<?php echo $inventory['unit_cost']; ?>" readonly>
                                </div>
                                <div class="form-group col-12">
                                    <label class="col-form-label">Estimated Useful Life</label>
                                    <input class="form-control" type="text" name="est_life" value="<?php echo $inventory['est_life']; ?>" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="submit" class="btn green radius-xl outline" name="archive-inventory" value="Archive" onClick="return validateQty(<?php echo $inv_id; ?>)">
                    <button type="button" class="btn red outline radius-xl" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </form>
</div> <!-- Archive inventory record modal -->

<script>
    function validateQty(invId) {
        var qtyPcard = document.getElementById('qty_pcard-' + invId).value;
        var qtyPcount = document.getElementById('qty_pcount-' + invId).value;
        if (qtyPcard != qtyPcount) {
            alert('Cannot archive record. Quantity per property card does not match quantity per physical count.');
            return false;
        }
        return confirm('Archive This Record?');
    }
</script> 

										<?php endforeach; ?>
									<?php endif; ?>
								</tbody>
							</table>
						</div> <!-- table-responsive -->

						<?php	
							/* Insert inventory record controller */	
							if (isset($_POST['insert-inventory'])) {
								$property_no = $_POST['property_no'];
								$acquired_date = $_POST['acquired_date'];
								$description = $_POST['description'];
								$category = $_POST['category'];
								$unit = $_POST['unit'];
								$qty_pcard = $_POST['qty_pcard'];
								$cost = $_POST['cost'];
								$est_life = $_POST['est_life'];
								$remark = $_POST['remark'];
							
								// File upload handling
								$imagePath = '';
								if (isset($_FILES['product-image-background']) && $_FILES['product-image-background']['error'] == 0) {
									$upload_dir = "../assets/images/";
									$file_name = uniqid() . '-' . basename($_FILES['product-image-background']['name']);
									$upload_file = $upload_dir . $file_name;
									$imageFileType = strtolower(pathinfo($upload_file, PATHINFO_EXTENSION));
							
									if (in_array($imageFileType, ['jpg', 'jpeg', 'png', 'gif'])) {
										if (move_uploaded_file($_FILES['product-image-background']['tmp_name'], $upload_file)) {
											$imagePath = $file_name;
										} else {
											echo "<script>alert('File upload failed.');</script>";
											$imagePath = null;
										}
									} else {
										echo "<script>alert('Invalid file type.');</script>";
										$imagePath = null;
									}
								}
							
								// Check if property number exists
								$checkPropertyNoExist = $model->checkPropertyNoExist($property_no);
								
								if (!$checkPropertyNoExist) {
									// Insert into the database
									$model->insertInventory($property_no, $category, $description, $qty_pcard, $unit, $cost, $est_life, $acquired_date, $remark, $imagePath);
									
									echo "<script>alert('Inventory has been added!');window.open('inventory', '_self')</script>";
								} else {
									echo "<script>alert('Property No. already exists!');</script>";
								}
							}							
							

							/* Update inventory record controller */
							if (isset($_POST['update-inventory'])) {
								$inv_id = $_POST['inv_id'];
								$main_inv_id = $_POST['mainInv_no'];
								$main_prop_no = $_POST['mainProp_no'];
								$property_no = $_POST['property_no'];
								$acquired_date = $_POST['acquired_date'];
								$description = $_POST['description'];
								$category = $_POST['category'];
								$unit = $_POST['unit'];
								$qty_pcard = $_POST['qty_pcard'];
								$cost = $_POST['cost'];
								$est_life = $_POST['est_life'];
								$remark = $_POST['remark'];

								// Fetch old values
    							$oldValues = $model->getInventoryByInvId($inv_id);

								$checkInvNoExist = $model->checkInvNoExist($inv_id);
								$checkPropertyNoExist = $model->checkPropertyNoExist($property_no);

								// Inventory No. should not already exist or should be the same
								if (!$checkInvNoExist || $main_inv_id == $inv_id) {
									// Property No. should not already exist or should be the same.
									if(!$checkPropertyNoExist || $main_prop_no == $property_no) {
										
										$model->updateInventory($property_no, $description, $category, $qty_pcard, $unit, $cost, $est_life, $acquired_date, $remark, $inv_id);

										$model->logTransactionInventoryUpdate($oldValues, $_POST);
										
										echo "<script>alert('Inventory has been updated!');window.open('inventory', '_self')</script>";
									} else {
										echo "<script>alert('Property No. already exists!');</script>";
									}
								} else {
									echo "<script>alert('Inventory No. already exists!');</script>";
								}
								
							}

							/* Archive inventory record controller */
							if (isset($_POST['archive-inventory'])) {
								$inv_id = $_POST['inv_id'];
								$model->archiveInventory($inv_id);

								echo "<script>alert('Inventory has been archived!');window.open('inventory', '_self')</script>";
							}
							
						?>
							
					</div> <!-- widget-inner -->
				</div> <!-- widget-box -->
			</div> <!-- col-lg-12 -->
		</div> <!-- row -->
	</div> <!-- container-fluid -->
</main> <!-- ttr-wrapper -->

<!-- header & styles -->
<?php include('../includes/layouts/main-layouts/footer.php') ?>
